workflows:
  ios-workflow:
    name: iOS Build Workflow
    max_build_duration: 60

    environment:
      ruby: 3.1.0  # Bruk Ruby 3.1.0 for stabilitet
      vars:
        APP_STORE_API_KEY: $APP_STORE_API_KEY
        APP_STORE_KEY_ID: $APP_STORE_KEY_ID
        APP_STORE_ISSUER_ID: $APP_STORE_ISSUER_ID
      xcode: latest  # Bruker den nyeste versjonen av Xcode

    scripts:
      - name: Install Ruby version 3.1.0
        script: |
          echo "Sjekker og installerer Ruby 3.1.0..."
          if ! rbenv versions | grep -q '3.1.0'; then
            rbenv install 3.1.0 --skip-existing
          fi
          rbenv global 3.1.0
          ruby -v

      - name: Install CocoaPods dependencies
        script: |
          echo "Oppdaterer CocoaPods..."
          gem install cocoapods --user-install
          pod setup  # Sørger for at CocoaPods er riktig konfigurert

          echo "Kjører pod install..."
          cd ios
          pod install --verbose || { echo 'pod install feilet'; exit 1; }

      - name: Build iOS app
        script: |
          echo "Bygger iOS-appen..."
          xcodebuild \
            -workspace ios/KitchenApp.xcworkspace \
            -scheme KitchenApp \
            -configuration Release \
            -sdk iphoneos \
            -archivePath $CM_BUILD_DIR/KitchenApp.xcarchive \
            archive || { echo 'Build feilet'; exit 1; }

      - name: Export .ipa file
        script: |
          echo "Eksporterer IPA..."
          xcodebuild \
            -exportArchive \
            -archivePath $CM_BUILD_DIR/KitchenApp.xcarchive \
            -exportOptionsPlist ios/ExportOptions.plist \
            -exportPath $CM_BUILD_DIR || { echo 'Export feilet'; exit 1; }

    artifacts:
      - build/ios/ipa/*.ipa  # Sørger for at .ipa-filen blir tilgjengelig etter bygging

    publishing:
      app_store_connect:
        api_key: $APP_STORE_API_KEY
        key_id: $APP_STORE_KEY_ID
        issuer_id: $APP_STORE_ISSUER_ID

